<view class="container">
  <!-- ç”¨æˆ·ä¿¡æ¯æ  -->
  <view class="user-info-bar">
    <block wx:if="{{userInfo.isLogin}}">
      <view class="user-info-left">
        <image class="avatar" src="{{userInfo.avatarUrl || '/images/me-active.png'}}" mode="aspectFill"></image>
        <view class="user-details">
          <view class="user-name-row">
            <text class="user-name">{{userInfo.name || 'ç”¨æˆ·'}}</text>
            <view class="user-level" bindtap="showLevelDetail">
            <block wx:if="{{userLevel.level > 0 && levelIconPath}}">
              <image class="level-icon" src="{{levelIconPath}}" mode="aspectFit" bindtap="previewLevelIcon" bindlongpress="downloadLevelIcon"></image>
              <text class="level-name">{{userLevel.name || 'æœªè§£é”'}}</text>
            </block>
            <block wx:else>
              <text class="level-icon-emoji">ğŸ´</text>
              <text class="level-name">æœªè§£é”</text>
            </block>
          </view>
          </view>
          <text class="edit-text" bindtap="onEditProfile">ç¼–è¾‘</text>
        </view>
      </view>
      <view class="login-btn" bindtap="onLogin">
        <text>é€€å‡º</text>
      </view>
    </block>
    <block wx:else>
      <view class="user-info-left">
        <image class="avatar" src="/images/me-active.png" mode="aspectFill"></image>
        <view class="user-details">
          <text class="user-name">{{userInfo.name}}</text>
        </view>
      </view>
      <view class="login-btn" bindtap="onLogin">
        <text>ç™»å½•</text>
      </view>
    </block>
  </view>

  <!-- åé¦ˆæŒ‰é’® -->
  <view class="feedback-container" bindtap="showFeedbackForm">
    <view class="feedback-title">
      <text>æˆ‘æœ‰è¯è¯´</text>
      <image class="feedback-icon" src="/images/speak.png" mode="aspectFit"></image>
    </view>
  </view>

  <!-- å†å²è®°å½•æ ‡é¢˜ -->
  <view class="section-title">å†å²è®°å½•</view>

  <!-- å†å²è®°å½•åˆ—è¡¨ -->
  <view class="history-list">
    <view 
      wx:for="{{historyList}}" 
      wx:key="id" 
      class="history-item {{index % 2 === 0 ? 'even' : 'odd'}}"
    >
      <view class="item-content">
        <text class="position-name">{{item.positionName}}</text>
        <text class="create-time">{{item.formattedTime}}</text>
      </view>
      <view class="item-actions">
        <view 
          wx:if="{{item.fullData.beautified_resume_url}}" 
          class="download-btn" 
          bindtap="downloadHistoryResume" 
          data-id="{{item.id}}"
        >
          ä¸‹è½½
        </view>
        <view 
          class="delete-btn" 
          bindtap="deleteHistoryItem" 
          data-id="{{item.id}}"
        >
          åˆ é™¤
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{historyList.length === 0 && !isLoading}}" class="empty-state">
      <text>æš‚æ— å†å²è®°å½•</text>
    </view>

    <!-- åŠ è½½ä¸­çŠ¶æ€ -->
    <view wx:if="{{isLoading}}" class="loading-state">
      <text>æ­£åœ¨åŠ è½½...</text>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view wx:if="{{hasMore && !isLoading && historyList.length > 0}}" class="load-more" bindtap="loadMore">
      <text>åŠ è½½æ›´å¤š</text>
    </view>

    <!-- æ²¡æœ‰æ›´å¤šæ•°æ® -->
    <view wx:if="{{!hasMore && historyList.length > 0}}" class="no-more">
      <text>æ²¡æœ‰æ›´å¤šæ•°æ®äº†</text>
    </view>
  </view>
</view>

<!-- ç­‰çº§è¯¦æƒ…å¼¹çª— -->
<view wx:if="{{showLevelDetail}}" class="level-modal">
  <view class="level-modal-content">
    <view class="level-modal-header">
      <text class="level-modal-title">ç­‰çº§è¯¦æƒ…</text>
      <view class="level-modal-close" bindtap="closeLevelDetail">Ã—</view>
    </view>
    <view class="level-modal-body">
      <view class="level-info">
        <block wx:if="{{userLevel.level > 0 && levelIconPath}}">
          <image class="level-icon-large" src="{{levelIconPath}}" mode="aspectFit" bindtap="previewLevelIcon" bindlongpress="downloadLevelIcon"></image>
        </block>
        <block wx:else>
          <text class="level-icon-large-emoji" bindtap="previewLevelIcon" bindlongpress="downloadLevelIcon">ğŸ´</text>
        </block>
        <text class="level-description">{{userLevel.description || 'ç­‰çº§æè¿°'}}</text>
      </view>
      <view class="level-progress">
        <text class="progress-text">ç­‰çº§è¿›åº¦</text>
        <view class="progress-container">
          <view class="progress-bar" style="width: {{userLevel.progress || 0}}% !important;"></view>
        </view>
        <text class="progress-value">{{userLevel.progress || 0}}%</text>
      </view>
      <view class="level-tip">
        <text>{{userLevel.next_level_requirement || 'ç»§ç»­åŠªåŠ›'}}</text>
      </view>
      <view class="level-secret" bindlongpress="showSecretTip">
        <text>é•¿æŒ‰æŸ¥çœ‹ç§˜å¯†æç¤º</text>
      </view>
    </view>
  </view>
</view>

<!-- å¤§å›¾é¢„è§ˆå¼¹çª— -->
<view wx:if="{{showImagePreview}}" class="image-preview-modal" bindtap="closeImagePreview">
  <view class="image-preview-content" catchtap="">
    <image class="preview-image" src="{{previewImagePath}}" mode="aspectFit"></image>
    <view class="preview-close" bindtap="closeImagePreview">Ã—</view>
  </view>
</view>

<!-- æˆåŠŸæç¤ºå¼¹çª— -->
<view wx:if="{{showSuccess}}" class="success-modal">
  <view class="success-modal-content">
    <view class="success-header">
      <text class="success-title">æ„Ÿè°¢åé¦ˆ</text>
    </view>
    <view class="success-body">
      <view class="success-content">
        <text class="success-text">åŠŸå¾·+1</text>
        <image class="success-image" src="/images/fish.png" mode="aspectFit"></image>
      </view>
    </view>
    <view class="success-footer">
      <view class="success-btn" bindtap="closeSuccessModal">ç¡®å®š</view>
    </view>
  </view>
</view>

<!-- åé¦ˆè¡¨å•å¼¹çª— -->
<view wx:if="{{showFeedback}}" class="feedback-modal">
  <view class="feedback-modal-content">
    <view class="feedback-modal-header">
      <text class="feedback-modal-title">ç”¨æˆ·åé¦ˆ</text>
      <view class="feedback-modal-close" bindtap="closeFeedbackForm">Ã—</view>
    </view>
    
    <view class="feedback-form">
      <!-- åé¦ˆç±»å‹ -->
      <view class="form-item">
        <text class="form-label required">åé¦ˆç±»å‹<text class="required-mark">*</text></text>
        <view class="feedback-type-selector">
          <view class="feedback-type-item {{feedbackData.feedback_type === 'bug' ? 'active' : ''}}" bindtap="selectFeedbackType" data-type="bug">
            <text>é—®é¢˜åé¦ˆ</text>
          </view>
          <view class="feedback-type-item {{feedbackData.feedback_type === 'feature' ? 'active' : ''}}" bindtap="selectFeedbackType" data-type="feature">
            <text>åŠŸèƒ½å»ºè®®</text>
          </view>
          <view class="feedback-type-item {{feedbackData.feedback_type === 'other' ? 'active' : ''}}" bindtap="selectFeedbackType" data-type="other">
            <text>å…¶ä»–</text>
          </view>
        </view>
      </view>
      
      <!-- åé¦ˆæ ‡é¢˜ -->
      <view class="form-item">
        <text class="form-label required">åé¦ˆæ ‡é¢˜<text class="required-mark">*</text></text>
        <input 
          class="form-input" 
          placeholder="è¯·è¾“å…¥åé¦ˆæ ‡é¢˜" 
          value="{{feedbackData.title}}"
          bindinput="onFeedbackInput"
          data-field="title"
        />
      </view>
      
      <!-- åé¦ˆå†…å®¹ -->
      <view class="form-item">
        <text class="form-label required">åé¦ˆå†…å®¹<text class="required-mark">*</text></text>
        <textarea 
          class="form-textarea" 
          placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„é—®é¢˜æˆ–å»ºè®®" 
          value="{{feedbackData.content}}"
          bindinput="onFeedbackInput"
          data-field="content"
          maxlength="500"
          auto-height
        />
        <text class="char-count">{{feedbackData.content.length}}/500</text>
      </view>
      
      <!-- è”ç³»æ–¹å¼ -->
      <view class="form-item">
        <text class="form-label">è”ç³»æ–¹å¼</text>
        <input 
          class="form-input" 
          placeholder="è¯·è¾“å…¥é‚®ç®±æˆ–æ‰‹æœºå·ï¼ˆé€‰å¡«ï¼‰" 
          value="{{feedbackData.contact}}"
          bindinput="onFeedbackInput"
          data-field="contact"
        />
      </view>
      
      <!-- æäº¤æŒ‰é’® -->
      <view 
        class="submit-btn" 
        bindtap="submitFeedback"
        style="pointer-events: {{isSubmitting ? 'none' : 'auto'}}; opacity: {{isSubmitting ? 0.6 : 1}}"
      >
        <text wx:if="{{isSubmitting}}">æäº¤ä¸­...</text>
        <text wx:else>æäº¤</text>
      </view>
    </view>
  </view>
</view>