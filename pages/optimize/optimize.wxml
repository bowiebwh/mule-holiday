<view class="container">
  <view class="section">
    <view class="title">输入目标岗位</view>
    <text class="tip">请自选：应聘职位的网页URL、JD文字描述、截图</text>
    <!-- 图片上传按钮 -->
    <view class="upload-image-btn" bindtap="chooseImage">
      <text class="upload-icon">📷</text>
      <text class="upload-text">上传职位截图（OCR识别）</text>
    </view>
    <view class="textarea-wrapper">
      <textarea 
        class="input-job" 
        placeholder="https://www.bosszhipin.com/job/..." 
        placeholder-style="color: #d1d5db;" 
        bindinput="onJobUrlInput" 
        bindfocus="onJobUrlFocus" 
        bindblur="onJobUrlBlur" 
        bindlinechange="onJobUrlLineChange" 
        value="{{jobUrl}}" 
        maxlength="2000" 
        show-confirm-bar="{{false}}"
      />
      <text class="clear-btn" wx:if="{{jobUrl}}" bindtap="clearJobUrl">×</text>
      <text class="char-count">{{jobUrl.length}}/2000</text>
    </view>
    <button class="btn" bindtap="analyzeJob" disabled="{{!jobUrl}}" wx:if="{{isSubmitCalled}}">
      重新分析岗位
    </button>
  </view>
  
  <view class="section">
    <view class="title">上传并优化简历</view>
    <text class="tip">支持 PDF、DOCX、TXT 格式</text>
    <view class="file-upload" bindtap="chooseResumeFile">
      <text class="file-icon">📄</text>
      <text class="file-upload-label">点击上传简历</text>
      <text class="file-hint">或拖拽文件到此处</text>
      <text class="file-name" wx:if="{{fileName}}">{{fileName}}</text>
    </view>
  </view>
  
  <view class="section" wx:if="{{jobInfo.position_name}}">
    <view class="job-info">
      <!-- 可编辑的岗位名称 -->
      <view class="job-header">
        <view class="editable-title">
          <input 
            wx:if="{{isEditingPosition}}" 
            class="editable-input" 
            value="{{jobInfo.position_name}}" 
            bindblur="savePosition" 
            focus="{{isEditingPosition}}"
            placeholder="请输入岗位名称"
          />
          <text 
            wx:else 
            class="job-title" 
            bindtap="startEditPosition"
          >{{jobInfo.position_name}}</text>
          <icon class="edit-icon" type="edit" size="24" bindtap="startEditPosition" />
        </view>
        <text class="job-tag">{{jobInfo.job_type || '全职'}}</text>
      </view>
      
      <view class="job-details" wx:if="{{jobInfo.salary}}">
        <text class="salary">{{jobInfo.salary}}</text>
        <text class="company">{{jobInfo.company_name || ''}}</text>
      </view>
    </view>
  </view>
  
  <view class="section" wx:if="{{jobInfo.requirements.length > 0}}">
    <view class="title">岗位信息</view>
    <view class="requirements-list">
      <!-- 可展开/收起的岗位要求 -->
      <view class="requirement-item" wx:for="{{jobInfo.requirements}}" wx:key="index">
        <!-- 标题项 -->
        <view wx:if="{{item.isTitle}}" class="requirement-title">
          {{item.title}}
        </view>
        
        <!-- 内容项 -->
        <view wx:else class="requirement-header">
          <view class="requirement-content">{{item.content}}</view>
        </view>
      </view>
    </view>
    
  </view>
  
  <view class="section" wx:if="{{result.beautified_resume_url || result.beautified_resume}}">
    <view class="title">优化后的简历</view>
    <view class="download-resume" bindtap="downloadBeautifiedResume">
      <view class="download-info">
        <view class="download-name">个人简历.docx</view>
        <view class="download-size">DOCX格式</view>
      </view>
      <view class="download-icon">📥</view>
    </view>
    <!-- 真实性提醒 -->
    <view class="authenticity-reminder" wx:if="{{isSubmitCalled}}">
      ⚠️注意：如生成的量化结果与实际不符，请用户自行调整为真实情况。
    </view>
  </view>

  <view class="section" wx:if="{{isSubmitCalled && (jobInfo.position_name || fileName)}}">
    <view class="title">快捷操作</view>
    <view class="quick-actions">
      <view class="quick-action-item" bindtap="generateInterviewScript">
        <view class="action-icon">💬</view>
        <view class="action-content">
          <view class="action-title">重新生成面试话术</view>
          <view class="action-desc">基于岗位和简历生成个性化面试话术</view>
        </view>
        <view class="action-arrow">→</view>
      </view>
      <view class="quick-action-item" bindtap="generateLearningPlan">
        <view class="action-icon">📅</view>
        <view class="action-content">
          <view class="action-title">重新生成学习计划</view>
          <view class="action-desc">规划个性化的技能提升学习路径</view>
        </view>
        <view class="action-arrow">→</view>
      </view>
    </view>
  </view>
  
  
  
  <!-- 进度条 -->
  <view class="progress" wx:if="{{isLoading}}">
    <view class="progress-bar">
      <view class="progress-fill" style="width: {{progress}}% !important;"></view>
    </view>
    <text class="progress-text">处理中... {{progress}}%</text>
  </view>
</view>

<!-- 固定在底部紧贴tab栏的一键生成全部按钮 -->
<view class="fixed-bottom-btn" wx:if="{{!isSubmitCalled}}">
  <button class="btn" bindtap="submitForm" disabled="{{isLoading || !jobUrl || !fileName}}">
    <text wx:if="{{isLoading}}">处理中...</text>
    <text wx:else>⚡ 一键生成全部</text>
  </button>
</view>

<!-- 一键清除按钮，在一键生成全部调用完成后显示 -->
<view class="fixed-bottom-btn" wx:if="{{isSubmitCalled}}">
  <button class="btn btn-clear" bindtap="clearAllData">
    <text>🗑️ 一键清除缓存</text>
  </button>
</view>

<!-- 遮罩层：点击别处关闭悬浮框 -->
<view 
  class="float-box-overlay" 
  wx:if="{{floatBoxExpanded}}"
  catchtap="onFloatBoxOverlayTap"
></view>

<!-- 可拖动队列状态悬浮框 -->
<view 
  class="queue-float-box" 
  style="left: {{floatBoxPosition.x}}px; top: {{floatBoxPosition.y}}px;"
  bindtouchstart="onFloatBoxTouchStart"
  bindtouchmove="onFloatBoxTouchMove"
  bindtouchend="onFloatBoxTouchEnd"
  bindtap="onFloatBoxTap"
>
  <!-- 基础状态：显示队列总人数 -->
  <view class="float-box-base" wx:if="{{!floatBoxExpanded}}">
    <view class="queue-count">{{queueTotal}}</view>
    <view class="queue-label">排队</view>
  </view>
  
  <!-- 展开状态：显示详细队列信息 -->
  <view class="float-box-expanded" wx:if="{{floatBoxExpanded}}">
    <view class="expanded-header">
      <view class="expanded-title">队列状态</view>
    </view>
    
    <view class="expanded-content">
      <!-- 队列总览 -->
      <view class="queue-overview">
        <view class="overview-item">
          <view class="overview-label">队列总人数</view>
          <view class="overview-value">{{queueTotal}}</view>
        </view>
        <view class="overview-item" wx:if="{{queueStats.avg_wait_time}}">
          <view class="overview-label">平均等待时间</view>
          <view class="overview-value">{{Math.ceil(queueStats.avg_wait_time / 60)}}分钟</view>
        </view>
        <view class="overview-item" wx:if="{{estimatedWaitTimeFormatted}}">
          <view class="overview-label">预计等待时间</view>
          <view class="overview-value">{{estimatedWaitTimeFormatted}}</view>
        </view>
      </view>
      
      <!-- 排队提示 -->
      <view class="queue-tip" wx:if="{{queueTip}}">
        <view class="tip-content">{{queueTip}}</view>
      </view>
      
      <!-- 个人任务状态 -->
      <view class="personal-task" wx:if="{{status === 'QUEUED' || status === 'RUNNING' || status === 'SUCCESS' || status === 'FAILED' || status === 'CANCELLED'}}">
        <view class="task-header">您的任务</view>
        
        <!-- 排队状态 -->
        <view class="task-info" wx:if="{{status === 'QUEUED'}}">
          <view class="task-item">
            <view class="task-label">当前位置</view>
            <view class="task-value">{{queuePosition}}</view>
          </view>
          <view class="task-item">
            <view class="task-label">预计等待</view>
            <view class="task-value">{{Math.ceil(estimatedWaitTime / 60)}}分钟</view>
          </view>
          <button class="cancel-btn" bindtap="cancelTask">取消任务</button>
        </view>
        
        <!-- 执行中状态 -->
        <view class="task-info running" wx:if="{{status === 'RUNNING'}}">
          <view class="progress-bar small">
            <view class="progress-fill" style="width: {{progress}}% !important;"></view>
          </view>
          <view class="progress-info small">
            <view class="progress-text">{{progressMessage || '处理中...'}}</view>
            <view class="progress-percent">{{progress}}%</view>
          </view>
          <button class="cancel-btn" bindtap="cancelTask">取消任务</button>
        </view>
        
        <!-- 成功状态 -->
        <view class="task-info success" wx:if="{{status === 'SUCCESS'}}">
          <view class="status-icon success">✅</view>
          <view class="status-info">
            <view class="status-title">处理完成</view>
            <view class="status-message">分析结果已生成</view>
          </view>
        </view>
        
        <!-- 失败状态 -->
        <view class="task-info error" wx:if="{{status === 'FAILED'}}">
          <view class="status-icon error">❌</view>
          <view class="status-info">
            <view class="status-title">处理失败</view>
            <view class="status-message">{{error || '请稍后重试'}}</view>
          </view>
        </view>
        
        <!-- 已取消状态 -->
        <view class="task-info cancelled" wx:if="{{status === 'CANCELLED'}}">
          <view class="status-icon cancelled">⏹️</view>
          <view class="status-info">
            <view class="status-title">任务已取消</view>
            <view class="status-message">您已取消该任务</view>
          </view>
        </view>
      </view>
      
      <!-- 系统提示 -->
      <view class="system-tip" wx:if="{{queueTotal > 1000}}">
        <view class="tip-icon">⚠️</view>
        <view class="tip-text">当前队列人数较多，可能需要较长时间等待，请耐心等待或稍后再来。</view>
      </view>
      
      <!-- 使用次数显示 -->
      <view class="usage-limits">
        <view class="usage-header">
          <view class="usage-title">今日剩余次数</view>
        </view>
        <view class="usage-list">
          <view class="usage-item">
            <view class="usage-label">⚡ 一键生成全部</view>
            <view class="usage-value">{{userUsage.stream_run_remaining}}/1</view>
          </view>
          <view class="usage-item">
            <view class="usage-label">💬 面试话术</view>
            <view class="usage-value">{{userUsage.interview_remaining}}/1</view>
          </view>
          <view class="usage-item">
            <view class="usage-label">📅 学习计划</view>
            <view class="usage-value">{{userUsage.learning_path_remaining}}/1</view>
          </view>
          <view class="usage-item">
            <view class="usage-label">🤖 AI 助手对话</view>
            <view class="usage-value">{{userUsage.chat_remaining}}/5</view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>